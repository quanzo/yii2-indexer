indexer модуль для Yii 2
========================

Модуль предназначен для сохранения формируемого контента в БД для дальнейщего
поиска.

Страницы, полученные через POST, будут игнорироваться.

Обязательно задать, через параметр *exclude*, адреса которые не должны попасть в
базу.

Используется полнотекстовый поиск Mysql

При сохранении, url формируется как `путь/к/action?параметры`, например
`site/default/index?param=1`

Установка и подключение
-----------------------

1.  Скопировать в папку с модулями

2.  Установить структуру таблиц из миграции

3.  Подключить *autoload.php*

4.  Подключить в *сonfig.php*

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
$config = [
    'bootstrap' => [
        'indexer',
    ],
    'modules' => [
        'indexer' => [
            'class' => 'x51\yii2\modules\indexer\Module',
            /*
            'fullpageMode' => false, // сохранять всю страницу или только контент (без layout)
            'ttl' => 86400, // время жизни содержимого в БД, в сек.
            'exclude' => [], // роуты в которых запрещено использование. Можно применять символы ? и *
            'layoutRule' => '*/layouts/*', // маска для определения layout
            'saveOrigContent' => true, // сохранять в БД html
            'saveOrigTitle' => true, // сохранять в БД оригинал заголовока страницы
            'defaultPageSize' => 15, // размер страницы поиска по умолчанию
            'enableHashtags' => true, // обработка хештегов на страницах. они становятся ссылками на поиск
            'notShowOld' => false, // не показывать старые записи в поиске
            'on '.\x51\yii2\modules\indexer\Module::EVENT_BEFORE_INDEX => function ($event) {}, // событие перед сохранением страницы в БД
            'on '.\x51\yii2\modules\indexer\Module::EVENT_BEFORE_SEARCH => function ($event) {}, // событие перед началом поиска
            */
        ],
    ], // end modules
];
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

 

Использование
-------------

Адрес страницы поиска: *http://site.domain/index.php?r=indexer*

События
-------

### EVENT_BEFORE_INDEX

Событие `\x51\yii2\modules\indexer\Module::EVENT_BEFORE_INDEX` вызывается перед
сохранением результата в БД.

В обработчик передается объект типа
`x51\yii2\modules\indexer\events\BeforeIndexEvent`

Если в объекте задать параметр `isValid=false`, то сохранение данных не
произойдет.

Также в объекте события доступны параметры:

-   *module* - ссылка на объект модуля

-   *model* - модель, подготовленная к сохранению. Эта модель и будет сохранена.
    Можно изменить данные перед сохранением.

### EVENT_BEFORE_SEARCH

Событие `\x51\yii2\modules\indexer\Module::EVENT_BEFORE_SEARCH` вызывается перед
старта поиска.

В обработчик передается объект типа
`x51\yii2\modules\indexer\events\BeforeSearchEvent`

В объекте события доступны данные:

-   *module* - ссылка на объект модуля

-   *origSearchStr* - оригинальная строка поиска

-   *preparedSearchStr* - строка, которая будет использоваться в поиске

### EVENT_START_RFRESH_INDEX

Событие `\x51\yii2\modules\indexer\Module::EVENT_START_REFRESH_INDEX` стартует перед началом обновления страницы в базе.

В объекте события доступны данные: 

- *module* - ссылка на текущий модуль
- *url* - адрес страницы
- *title* - оригинальный заголовок страницы (не обработанный для поиска)
- *content* - оригинальный контент  (не обработанный для поиска)
- *isValid* - true/false - позволяет разрешить/запретить обновление

Данные в объекте события можно модифицировать - именно они будут использованы для обновления. Например, можно убрать контент, которого быть не должно (он лишний при поиске).


Методы модуля
-------------

-   `function search($text, $perpage = false, $page = 1, &$count = false)`

Выполняет поиск.

Если задать `$perpage`, то будет постарничный вывод.

В `$count` возвращается общее колтчество найденных записей.

-   `function actualUrl($url)`

Формирует из url, сохраненного в БД, актуальный url.

-   `public function getIndex($url)`

По url возвращает сохраненную запись

-   `public function markOld($url)`

Помечает сохраненную страницу как устаревшую.

 

 

 

 
